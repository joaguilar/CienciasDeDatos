---
title: "Tarea 4"
author: "Jose Aguilar, Eilyn Salazar, Crisia Piedra"
date: "5/16/2020"
output: html_document
---

```{r setup, include=FALSE}
if(!require(arules)) install.packages("arules",dependencies = TRUE,repos=c(CRAN="https://cran.cnr.berkeley.edu/"))
library(arules)
if(!require(readxl)) install.packages("readxl",dependencies = TRUE,repos=c(CRAN="https://cran.cnr.berkeley.edu/"))
library("readxl")
library(ggplot2)
library(knitr)
if(!require(kableExtra)) install.packages("kableExtra",dependencies = TRUE,repos=c(CRAN="https://cran.cnr.berkeley.edu/"))
library(kableExtra)
library(arules)
library(arulesViz)

library(tidyverse)
if(!require(plyr)) install.packages("plyr",dependencies = TRUE)
library(plyr); library(dplyr)
library(ggplot2)
library(knitr)
library(lubridate)
if(!require(assertr)) install.packages("assertr",dependencies = TRUE)
library(assertr)
if(!require(reshape2)) install.packages("reshape2",dependencies = TRUE)
library(reshape2)
if(!require(rvest)) install.packages("rvest",dependencies = TRUE)
library(rvest)
if(!require(FactoMineR)) install.packages("FactoMineR",dependencies = TRUE)
library(FactoMineR)
if(!require(ggplot2)) install.packages("ggplot2",dependencies = TRUE)
library(ggplot2)

#Librerias de Clustering
if(!require(cluster)) install.packages("cluster",dependencies = TRUE)
library(cluster)
if(!require(factoextra)) install.packages("factoextra",dependencies = TRUE)
library(factoextra)
```
# Entendimiento del negocio

Para esta tarea se hará uso de la siguiente página  https://en.wikipedia.org/wiki/List_of_highest-grossing_video_game_franchises, la cual muestra las franquicias de video juegos con mayores ingresos.

El objetivo es explorar cuales son las compañias de juegos y franquicias más rentables

#	Entendimiento de los datos

La página seleccionada para realizar este análisis "List of highest-grossing video game franchises" está estructurada en 5 secciones: 

* Sección 1: Introducción en donde se explica el contenido de la página. El cuál es el mostrar el listado de compañías de juegos más rentables agrupados en 4 grandes grupos basado en el rango de ingresos en los que se encuentra cada franquicia, ya sean 10,5,2 o 1 millón de dólares 
* Sección 2: Detalle de los ingresos (Tablas). Para cada grupo se muestra una tabla la cual muestra el nombre de la Franquicia (Franchise), el año de creación (Year of inception), los ingresos de por vida (Lifetime revenue), Desglose de ingresos (Revenue breakdown), Dueño de la franquicia (Franchise owner), Plataforma Original (Original platforms), Genero Original (Original genre)
* Sección 3: Temas relacionados: URLs a sitios que contienen información relacionada a la página seleccionada.
* Sección 4: Notas.
* Sección 5: Referencias.

Para efectos del trabajo se hará uso únicamente de la sección 2, a continuación se presenta la caracterización de los atributos incluidos en cada tabla.


```{r warning=FALSE}
atributos<-read.csv('atributos.csv', sep = ',',dec = '.')
kable(atributos[,0:4],caption = "Descripción de los atributos")%>%
kable_styling(bootstrap_options = c("striped", "hover"))
```


## Exploración de los datos 

Se procede a realizar la extracción de los datos de cada tabla, los cuales se almacenarán en las variables, datos10m, datos5m, datos2m and datos1m.

```{r}
dirPag<-'https://en.wikipedia.org/wiki/List_of_highest-grossing_video_game_franchises'
pag<- read_html(dirPag,encoding = 'UTF-8')  
  
# se extraen específicamente las tablas que contenga la página
tablasPag<- html_table(pag,fill=TRUE)
#length(tablasPag)
#tablasPag
  
# Se obtienen las 4 tablas que agrupan los juegos de la compañia por cada uno de los juegos
datos10m<- tablasPag[[1]]
datos5m<- tablasPag[[2]]
datos2m<- tablasPag[[3]]
datos1m<- tablasPag[[4]]

# Se procede a añadir una columna categoria, para unir los valores de las tablas en un solo dataset.
datos10m['Categoria'] <- '10m'
datos5m['Categoria'] <- '5m'
datos2m['Categoria'] <- '2m'
datos1m['Categoria'] <- '1m'

#Se unen todos los dataframes en una sola.
datos <- rbind(datos10m,datos5m,datos2m,datos1m)
```

Una vez cargados los datos se preocede a hacer la exploración de los mismos. Como se puede apreciar, la mayoria de atributos al ser extraidos, son de tipo alfanumérico o caracter, en el caso del atributo "Year of inception" nos muestra que las fechas de creación de las franquicias van desde el año 1978 al año 2009.

```{r}
summary(datos)
```
## Verificación de la calidad de datos

Al explorar los datos es posible ver que no hay valores nulos o NAs. Con respecto a la normalización de los datos, se observan oportunidades de normalización de atributos como "Revenue breakdown", por ejemplo la franquicia "Mario", tiene agrupados sus ingresos en 3 juegos "Super Mario", "Mario Cart" y "Otros Mario games", sin embargo en el caso de "Call of Duty" los ingresos están agrupados por rangos de años o año, ejemplo: "2003-2017", "2018" y "2019".
 
#	Preparación de los datos 

## Selección de los datos 

Para efectos del trabajo se excluirá unicamente la columna Revenue Breakdown

```{r}
#Se remueve la columna Revenue Breakdown
datos<-datos[,-4] 
colnames(datos)

#Se renombran las nombres de las columnas
colnames(datos)<-c('Franquicia','Anno','Ingresos','Duenno','Plataforma','Genero', 'Categoria')
#datos
```

## Limpieza de los datos

Para el proceso de limpieza de datos se hizo uso de expresiones regulares para eliminar caracteres o palabras clave como: "$", "est." o realizar conversiones de datos a continuación se presentan las transformaciones realizadas.

Para el atributo Ingresos se aplicaron las siguientes transformaciones.
```{r warning=FALSE}
#Se elimina el símbolo $ y el texto est. y billions del campo Revenue
revenue<- str_remove(datos$Ingresos,'est\\.')
revenue<- str_remove(revenue,'\\s*\\$')
revenue<- str_remove(revenue,' billion.*$')
# Se convierte el atributo ingresos a un dato de tipo numérico y se multiplica por el valor billón.
revenue<- as.numeric(revenue)#*1000000000
datos$Ingresos<-revenue


```

Para el atributo Genero se aplicaron las siguientes transformaciones: Dejamos solamente el primer genero en el que fue clasificada la franquicia.
```{r warning=FALSE}
genres<-datos$Genero
genres<- str_remove(genres,' .*$')
datos$Genero <- genres
```

Para el atributo Plataforma se aplicaron las siguientes transformaciones: Dejamos solamente la primera plataforma en la que apareció la franquicia.

```{r warning=FALSE}
platfrom<-datos$Plataforma
platfrom
platfrom<- str_remove(platfrom,' /.*$')
platfrom<- str_remove(platfrom,'Comm.*$')
platfrom<- str_remove(platfrom,'HandheldPC.*$')
platfrom<- str_remove(platfrom,'PlayStationPC$')
platfrom<- str_remove(platfrom,'^IBM ')
platfrom<- str_replace(platfrom,'PlayStation 3Xbox 360','PlayStation 3')
platfrom<- str_replace(platfrom,'PS4Xbox OnePC','PS4')
datos$Plataforma<-platfrom
```

## Construcción de nuevos datos (atributos) 

Se creó un atributo nuevo llamado "Categoría" el cual es de tipo factor y fue usado para identificar el grupo al que pertenecen las franquicias basado en sus ingresos por billones. La creación de este atributo se realizó en la sección "Exploración de los datos", ya que fue necesario combinar los resultados de los datos originales para su limpieza y análisis.


## Transformaciones aplicadas a los datos 
 
Se convierten los atributos a tipos de dato factor y numeric según corresponda.

```{r warning=FALSE}
# Se realiza la conversión de atributos

#Copia de los datos originales
datosSinTransformaciones <- datos

datos$Franquicia <- as.factor(datos$Franquicia)
datos$Anno <- as.numeric(datos$Anno)
datos$Duenno <- as.factor(datos$Duenno)
datos$Plataforma <- as.factor(datos$Plataforma)
datos$Genero <- as.factor(datos$Genero)
datos$Categoria <- as.factor(datos$Categoria)
#str(datos)
#head(datos)

#Se utiliza la función omit para excluir cualquier valor NA. Sin embargo como se mencionó anteriormente basado en una revisión preliminar de los datos no hay valores nulos.   
datosFinal<-na.omit(datos)
head(datosFinal)
```
 
#	Fase de modelado  

## Selección de técnicas 

Para esta tarea se hará uso de las técnicas de agrupamiento Kmedias y Kmedoids a fin de comprar los resultados de ambas técnicas usando diferentes parámetros de K.

## Construcción de cada modelo.

### Construcción del modelo #1 (Kmedoids)

Para el modelo #1 se hace uso de la técnica Kmedoids.

### Selección de los parámetros modelo #1 (Kmedoids)

Para el primer modelo se analizarán las variables Ingresos y Dueños de Franquicia, y se hará uso de un k=3

### Ejecución modelo #1

```{r warning=FALSE}
# generar los clusters usando kmedoids
datosRenombrados <- datosFinal
row.names(datosRenombrados)<-datosRenombrados$Franquicia
clusters_kmedoids<-pam(datosRenombrados[,2:3],3)
```

### Descripción del modelo obtenido (Incluya al menos un gráfico)

En el siguiente modelo podemos observar los 3 clusters creados, 
```{r warning=FALSE}
# visualización de los clusters
fviz_cluster(clusters_kmedoids,data=dataSet,palette='jco')

# cluster al que se asignó cada individuo
clusteres_medoids <- clusters_kmedoids$clustering

# Descripción de los clusters
medoids <- clusters_kmedoids$medoids
medoids
```
Los 3 medoides de los 3 clusteres creados corresponden a ingresos entre "6.22", "3.43", "1.50".Lo que nos permite concluir que quizás una recomendación para el sitio web que publica estos resultados es crear categorias de ingresos por billón que vayan de 0 a 2, de 3 a 4, y de 6 a N, en lugar de las categorias de 1, 2, 5 y 10.

### Construcción del modelo #2 (Kmedias)

Para el modelo #2 se hace uso de la técnica Kmedias.

### Selección de los parámetros modelo #2 (Kmedias)

Para el segundo modelo se analizarán se usan unicamente las variables numéricas Año e Ingresos, y se hará uso de un k=3.

### Ejecución modelo #2

```{r warning=FALSE}
d <- datosFinal[,2:3]
clusters <- kmeans(d,3,nstart=1)
#obtener cantidad de registros en cada cluster y los centroides
descClusters<- data.frame(clusters$size,clusters$centers)
descClusters

# crear un data frame combinando el cluster asignado y los atributos originales
resultado <- data.frame(clusters$cluster,d)
head(resultado)
```
El resultado del algoritmo de kmedias nos permite observar como los 3 clusters creados agrupan la generación de ingresos en los siguientes 3 rangos de años:

* Cluster 1 de 1978 a 1996
* Cluster 2 en el año 2003 
* Cluster 3 en el año 2006 



### Descripción del modelo obtenido (Incluya al menos un gráfico)
```{r warning=FALSE}
ggplot(d,
       aes(d$Anno,d$Ingreso,
           color = clusters$cluster)) + geom_point()+
  ggtitle(label='Distribución por cluster')

# otra forma de visualizar los clusters
fviz_cluster(clusters,data=d[,c(1,2)],palette='jco',ggtheme = theme_minimal())


# cálculo del score Silhouette
score_sil<- silhouette(clusters$cluster,daisy(d))

# cálculo del valor óptimo de k usando el score silhouette
fviz_nbclust(d,kmeans,method = 'silhouette',k.max = 10)

# cálculo del valor óptimo de k usando el método del codo
fviz_nbclust(d,kmeans,method = 'wss',k.max = 10)

# cálculo del valor óptimo de k usando la estadística gap
fviz_nbclust(d,kmeans,method = 'gap_stat',k.max = 10)

```

## Evaluación de los modelos

### Comparación de los resultados obtenidos los modelos.

